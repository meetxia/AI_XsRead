# 小说内容清理工具使用指南

## 📋 工具简介

这是一个专门用于清理数据库中小说章节无关内容的Python脚本工具。它可以自动检测并删除"全文完"之后的内容，包括:

- 【金句集锦】
- 创作说明
- 推荐场景
- 适合人群
- 预期效果
- 其他无关的附加内容

## 🎯 功能特点

1. **智能检测**: 自动识别多种"全文完"的表达方式
2. **安全预览**: 提供预览模式,不会直接修改数据库
3. **详细报告**: 显示每个章节的清理详情和统计信息
4. **批量处理**: 可一次性处理所有需要清理的章节
5. **事务支持**: 出错时自动回滚,保证数据安全

## 📦 环境准备

### 1. 安装Python依赖

```bash
# 进入backend/scripts目录
cd backend/scripts

# 安装依赖
pip install -r requirements-clean.txt
```

或者直接安装:

```bash
pip install mysql-connector-python
```

### 2. 配置数据库连接

脚本会自动从环境变量读取数据库配置,如果没有配置环境变量,将使用以下默认值:

```python
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=toefl_user
DB_PASSWORD=mojz168168-
DB_DATABASE=ai_xsread
```

如需修改,可以:

**方式1: 设置环境变量** (推荐)

Windows PowerShell:
```powershell
$env:DB_HOST="127.0.0.1"
$env:DB_USER="your_user"
$env:DB_PASSWORD="your_password"
```

**方式2: 直接修改脚本**

编辑 `clean-novel-content.py` 文件中的 `DB_CONFIG` 配置项。

## 🚀 使用步骤

### 第一步: 启动脚本

```bash
cd backend/scripts
python clean-novel-content.py
```

### 第二步: 选择操作

脚本会显示一个交互式菜单:

```
请选择操作:
1. 🔍 预览需要清理的章节 (前5个)
2. 🔍 预览模式 - 检查所有章节但不修改数据库
3. ✍️  执行模式 - 实际清理并更新数据库
4. 🚪 退出
```

### 第三步: 操作说明

#### 选项1: 预览前5个需要清理的章节

- 显示包含"全文完"或无关标记的前5个章节
- 展示这些章节的详细内容
- 帮助你了解需要清理的内容

**适用场景**: 首次使用,想先看看有哪些章节需要清理

#### 选项2: 预览模式

- 扫描所有章节
- 显示清理计划和预期效果
- **不会修改数据库**
- 生成详细的清理报告

**适用场景**: 在实际清理前,想看看整体的清理情况

#### 选项3: 执行模式

- 实际执行清理操作
- **会修改数据库内容**
- 更新章节的content和word_count字段
- 需要输入 `yes` 确认

**适用场景**: 确认清理计划后,执行实际的清理操作

#### 选项4: 退出

- 关闭程序并断开数据库连接

## 📊 清理规则

### 1. 结束标志检测

脚本会检测以下结束标志 (按优先级):

```
- 全文完
- 全书完
- 正文完
- （全文完）
- (全文完)
- 【全文完】
- [全文完]
- ——全文完——
- ---全文完---
- 全剧终
- 大结局
- 完结
```

**处理方式**: 删除结束标志之后的所有内容

### 2. 无关标记删除

脚本会删除以下标记及其内容:

```
- 【金句集锦】
- 【创作说明】
- 【作者说明】
- 【推荐场景】
- 【适合人群】
- 【预期效果】
- 【爆款类型】
- 【结局类型】
- 创作说明:
- 作者的话:
- 作者有话说:
```

**处理方式**: 删除标记及其后续内容,直到下一个段落或文本结束

## 📖 使用示例

### 示例1: 首次使用 - 完整流程

```bash
# 1. 启动脚本
python clean-novel-content.py

# 2. 选择选项1,查看示例
请输入选项 (1-4): 1

# 3. 查看完示例后,选择选项2进行预览
请输入选项 (1-4): 2
继续? (y/n): y

# 4. 查看预览报告,确认清理计划

# 5. 如果确认无误,选择选项3执行清理
请输入选项 (1-4): 3
确认要执行清理操作? (yes/no): yes

# 6. 等待清理完成,查看统计报告

# 7. 选择选项4退出
请输入选项 (1-4): 4
```

### 示例2: 快速预览

```bash
python clean-novel-content.py
# 选择 1 查看示例
# 选择 4 退出
```

### 示例3: 直接清理 (熟悉流程后)

```bash
python clean-novel-content.py
# 选择 3 执行清理
# 输入 yes 确认
# 等待完成后选择 4 退出
```

## 📈 输出报告解读

### 清理详情示例

```
[15/127] 处理章节: 《网恋翻车了！三个暧昧对象竟是三胞胎》 - 第30章 大结局
    章节ID: 456
    📝 删除'全文完'后的内容(523字) | 删除标记: 【金句集锦】 | 原长度: 2856字, 清理后: 2333字, 删除: 523字
    原始内容末尾: ...从此过上了幸福的生活。全文完【金句集锦】1. "你在群里哭..."
    清理后内容末尾: ...从此过上了幸福的生活。
    ✅ 已更新到数据库
```

### 统计报告示例

```
📊 清理统计
================================================================================
总章节数: 127
已修改: 89
跳过: 38
删除总字符数: 45678
================================================================================
```

**字段说明**:
- **总章节数**: 扫描发现需要处理的章节总数
- **已修改**: 实际修改了的章节数量
- **跳过**: 无需修改的章节数量
- **删除总字符数**: 总共删除的字符数

## ⚠️ 注意事项

### 1. 数据备份

**强烈建议在执行清理前备份数据库!**

Windows备份命令:
```bash
mysqldump -u toefl_user -p ai_xsread > backup_before_clean_%date:~0,4%%date:~5,2%%date:~8,2%.sql
```

### 2. 测试环境

建议先在测试数据库上运行,确认效果后再在生产环境执行。

### 3. 预览模式

**首次使用务必先使用预览模式!** 确认清理计划无误后再执行实际清理。

### 4. 不可逆操作

执行模式会直接修改数据库,操作不可逆。请谨慎操作!

### 5. 性能考虑

- 大量章节处理可能需要较长时间
- 建议在低峰期执行
- 可以分批处理

## 🔧 常见问题

### Q1: 脚本无法连接数据库?

**解决方法**:
1. 检查MySQL服务是否启动
2. 验证数据库配置信息是否正确
3. 确认数据库用户有足够的权限

### Q2: 如何只清理特定小说的章节?

**解决方法**:

可以修改脚本中的 `get_chapters_to_clean` 函数,添加WHERE条件:

```python
query = """
    SELECT ...
    FROM chapters c
    WHERE c.novel_id = 123  # 指定小说ID
    AND c.content IS NOT NULL
"""
```

### Q3: 清理后发现有误,如何恢复?

**解决方法**:

如果之前有备份,可以恢复备份:

```bash
mysql -u toefl_user -p ai_xsread < backup_file.sql
```

### Q4: 如何添加新的清理规则?

**解决方法**:

编辑脚本中的以下配置:

1. 添加结束标志: 修改 `END_MARKERS` 列表
2. 添加无关标记: 修改 `UNWANTED_MARKERS` 列表

```python
END_MARKERS = [
    '全文完',
    '你的新标志',  # 添加这里
]

UNWANTED_MARKERS = [
    r'【金句集锦】',
    r'【你的新标记】',  # 添加这里
]
```

### Q5: 为什么有些章节没有被清理?

**可能原因**:
1. 该章节不包含任何结束标志或无关标记
2. 标记的格式与预设规则不匹配
3. 内容中包含特殊字符导致匹配失败

**解决方法**: 使用选项1查看具体章节内容,根据实际情况调整清理规则

## 📞 技术支持

如遇到问题,可以:

1. 查看脚本输出的错误信息
2. 检查数据库日志
3. 使用预览模式调试
4. 联系技术支持团队

## 📝 更新日志

### v1.0 (2025-10-31)
- ✅ 初始版本发布
- ✅ 支持多种"全文完"标志检测
- ✅ 支持常见无关标记清理
- ✅ 提供预览和执行两种模式
- ✅ 详细的清理报告和统计

---

**脚本位置**: `backend/scripts/clean-novel-content.py`  
**维护者**: 开发团队  
**最后更新**: 2025-10-31

