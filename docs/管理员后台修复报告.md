# 管理员后台修复报告

## 问题描述

管理员后台登录时出现 500 错误：
```
Error: Table 'ai_xsread.admin_users' doesn't exist
```

## 问题原因

数据库中缺少管理后台所需的表：
- `admin_users` - 管理员用户表
- `admin_logs` - 管理员操作日志表
- `banners` - 轮播图表
- `announcements` - 公告表
- `statistics_daily` - 每日统计表

## 修复过程

### 1. 创建了数据库表检查和创建脚本

#### `admin-backend/scripts/check-and-create-tables.js`
- 检查并创建 `admin_users` 表
- 检查并创建 `admin_logs` 表
- 创建默认管理员账号 (username: admin, password: admin123)

#### `admin-backend/scripts/check-all-tables.js`
- 检查并创建 `banners` 表
- 检查并创建 `announcements` 表
- 检查并创建 `statistics_daily` 表

### 2. 执行脚本创建表

```bash
cd admin-backend
node scripts/check-and-create-tables.js
node scripts/check-all-tables.js
```

### 3. 创建结果

✅ 所有表创建成功：
- `admin_users` - 管理员表（已创建默认管理员账号）
- `admin_logs` - 操作日志表
- `banners` - 轮播图表
- `announcements` - 公告表
- `statistics_daily` - 每日统计表

## 默认管理员账号

```
用户名: admin
密码: admin123
角色: 超级管理员
```

⚠️ **重要提示**: 登录后请立即修改默认密码！

## 数据库表结构

### admin_users (管理员表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT UNSIGNED | 管理员ID (主键) |
| username | VARCHAR(50) | 用户名 (唯一) |
| password | VARCHAR(255) | 密码 (bcrypt加密) |
| email | VARCHAR(100) | 邮箱 |
| avatar | VARCHAR(255) | 头像URL |
| role | VARCHAR(20) | 角色 (admin/super_admin) |
| permissions | JSON | 权限配置 |
| last_login_time | DATETIME | 最后登录时间 |
| last_login_ip | VARCHAR(50) | 最后登录IP |
| status | TINYINT | 状态 (0-禁用, 1-正常) |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### admin_logs (操作日志表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT UNSIGNED | 日志ID (主键) |
| admin_id | INT UNSIGNED | 管理员ID |
| admin_username | VARCHAR(50) | 管理员用户名 |
| action | VARCHAR(50) | 操作类型 |
| module | VARCHAR(50) | 模块 |
| target_id | INT UNSIGNED | 操作对象ID |
| description | TEXT | 操作描述 |
| ip | VARCHAR(50) | IP地址 |
| user_agent | VARCHAR(255) | 浏览器信息 |
| request_method | VARCHAR(10) | 请求方法 |
| request_url | VARCHAR(500) | 请求URL |
| created_at | DATETIME | 创建时间 |

### banners (轮播图表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT UNSIGNED | 轮播图ID (主键) |
| title | VARCHAR(100) | 标题 |
| image | VARCHAR(255) | 图片URL |
| link | VARCHAR(255) | 跳转链接 |
| link_type | VARCHAR(20) | 链接类型 |
| target_id | INT UNSIGNED | 目标ID |
| sort_order | INT | 排序顺序 |
| status | TINYINT | 状态 (0-隐藏, 1-显示) |
| start_time | DATETIME | 开始显示时间 |
| end_time | DATETIME | 结束显示时间 |
| views | INT UNSIGNED | 浏览量 |
| clicks | INT UNSIGNED | 点击量 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### announcements (公告表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT UNSIGNED | 公告ID (主键) |
| title | VARCHAR(100) | 公告标题 |
| content | TEXT | 公告内容 |
| type | VARCHAR(20) | 类型 (system/activity/notice) |
| position | VARCHAR(100) | 显示位置 |
| priority | TINYINT | 优先级 |
| status | TINYINT | 状态 (0-隐藏, 1-显示) |
| start_time | DATETIME | 开始显示时间 |
| end_time | DATETIME | 结束显示时间 |
| views | INT UNSIGNED | 浏览量 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### statistics_daily (每日统计表)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT UNSIGNED | 统计ID (主键) |
| date | DATE | 统计日期 (唯一) |
| new_users | INT UNSIGNED | 新增用户数 |
| active_users | INT UNSIGNED | 活跃用户数 |
| page_views | INT UNSIGNED | 页面浏览量 |
| unique_visitors | INT UNSIGNED | 独立访客数 |
| reading_duration | INT UNSIGNED | 总阅读时长 |
| avg_reading_duration | DECIMAL(10,2) | 人均阅读时长 |
| new_comments | INT UNSIGNED | 新增评论数 |
| new_collections | INT UNSIGNED | 新增收藏数 |
| new_likes | INT UNSIGNED | 新增点赞数 |
| revenue | DECIMAL(10,2) | 收入 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

## 测试步骤

1. 启动管理后台服务（如果没启动）：
```bash
cd admin-backend
npm start
```

2. 访问管理后台登录页面：
```
http://localhost:8001/
```

3. 使用默认账号登录：
```
用户名: admin
密码: admin123
```

4. 登录成功后应该能看到管理后台首页

## 后续维护

### 如何重置管理员密码

使用已有的初始化脚本：
```bash
cd admin-backend
node scripts/init-admin.js
```

按照提示选择是否重置密码。

### 如何添加新管理员

可以通过管理后台界面添加，或使用数据库直接插入：
```sql
-- 注意：密码需要先用 bcrypt 加密
INSERT INTO admin_users (username, password, email, role)
VALUES ('新用户名', '加密后的密码', '邮箱', 'admin');
```

### 定期清理日志

建议定期清理操作日志（保留最近90天）：
```sql
DELETE FROM admin_logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

## 相关文件

- `admin-backend/scripts/check-and-create-tables.js` - 检查并创建核心表
- `admin-backend/scripts/check-all-tables.js` - 检查并创建辅助表
- `admin-backend/scripts/init-admin.js` - 初始化/重置管理员账号
- `admin-backend/.env` - 环境变量配置文件
- `docx/06-数据库脚本/admin_tables.sql` - 完整的SQL建表脚本

## 注意事项

1. ⚠️ 登录后请立即修改默认密码
2. ⚠️ 不要将 `.env` 文件提交到版本控制
3. ⚠️ 生产环境务必使用强密码
4. ⚠️ 定期备份数据库
5. ⚠️ 定期清理操作日志以节省存储空间

## 修复完成时间

2025-10-31

## 修复状态

✅ 已修复 - 所有表已创建，管理后台可以正常登录

