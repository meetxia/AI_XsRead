# 评论功能 401 错误修复说明

## 问题描述
用户在已登录状态下发表评论时,收到 401 (Unauthorized) 错误。

## 问题原因
通过日志分析发现:
```
Token验证失败: { errorName: 'JsonWebTokenError', errorMessage: 'invalid signature' }
```

**根本原因**: 用户的 token 是用旧的 JWT_SECRET 生成的,但后端现在使用的是新的 JWT_SECRET,导致签名验证失败。

## 解决方案

### 立即解决方法(用户操作)
**请退出登录后重新登录**,这样会使用新的 JWT_SECRET 生成新的 token。

步骤:
1. 点击退出登录
2. 重新登录
3. 再次尝试发表评论

### 技术修复(已完成)

#### 1. 改进了错误提示信息
**后端** (`backend/src/middlewares/auth.js`):
- Token 过期: "登录已过期,请重新登录"
- Token 无效: "登录信息已失效,请重新登录"

**前端** (`ai-xsread-vue3/src/api/request.js`):
- 收到 401 错误时自动清除本地存储
- 弹出提示: "登录已失效,请重新登录"
- 自动跳转到登录页

#### 2. 添加了登录状态检查
**评论组件** (`ai-xsread-vue3/src/components/novel/CommentSection.vue`):
- 发表评论前检查登录状态
- 点赞前检查登录状态
- 回复前检查登录状态
- 未登录时提示并引导用户登录

#### 3. 改进了 CORS 配置
**后端配置** (`backend/src/config/index.js`):
```javascript
cors: {
  origin: [...],
  credentials: true,
  exposedHeaders: ['Authorization'],
  allowedHeaders: ['Content-Type', 'Authorization']
}
```

#### 4. 添加了详细的调试日志
- 前端请求拦截器记录 token 添加过程
- 后端认证中间件记录验证过程
- 方便后续问题排查

## 预防措施

### 避免 JWT_SECRET 变更
1. **生产环境**: 永远不要更改 JWT_SECRET
2. **开发环境**: 如果必须更改,需要:
   - 通知所有开发人员
   - 清除所有用户的 token
   - 要求所有用户重新登录

### Token 管理最佳实践
1. 使用 refresh token 机制(已实现)
2. 设置合理的过期时间(当前: 7天)
3. 在 token 即将过期时自动刷新

## 测试验证

### 测试步骤
1. 退出登录
2. 重新登录
3. 尝试发表评论
4. 检查浏览器控制台日志:
   ```
   🔑 添加 Token 到请求头: {...}
   ```
5. 检查后端终端日志:
   ```
   🔐 认证检查: {...}
   ✅ Token验证成功: {...}
   ```

### 预期结果
- ✅ 评论发表成功
- ✅ 评论立即显示在列表中
- ✅ 无 401 错误

## 相关文件

### 前端
- `ai-xsread-vue3/src/components/novel/CommentSection.vue` - 评论组件
- `ai-xsread-vue3/src/api/request.js` - 请求拦截器
- `ai-xsread-vue3/src/stores/user.js` - 用户状态管理

### 后端
- `backend/src/middlewares/auth.js` - 认证中间件
- `backend/src/config/index.js` - 配置文件
- `backend/.env` - 环境变量(包含 JWT_SECRET)
- `backend/src/routes/comments.js` - 评论路由
- `backend/src/controllers/commentController.js` - 评论控制器

## 注意事项

⚠️ **重要**: 
- JWT_SECRET 是敏感信息,不要提交到版本控制系统
- 生产环境的 JWT_SECRET 必须保密
- 定期检查 token 过期时间设置是否合理

