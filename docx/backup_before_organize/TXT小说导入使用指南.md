# TXT小说导入使用指南

**创建时间：** 2025-10-28  
**适用于：** 文字之境 AI_XsRead 项目  
**功能：** 批量导入TXT格式的短篇小说

---

## 一、快速开始

### 1.1 导入步骤（3步搞定）

```bash
# 步骤1：将TXT文件放入data目录
H:\momo-ruanjiansheji\AI_XsRead\data\你的小说.txt

# 步骤2：切换到backend目录
cd H:\momo-ruanjiansheji\AI_XsRead\backend

# 步骤3：运行导入脚本
node scripts/import-txt-novels.js
```

**就这么简单！** ✨

---

## 二、本次导入成果

### 2.1 导入统计

```
✅ 成功导入: 34个短篇小说
📊 总字数: 约35万字
📂 自动分类: 6个分类
⏱️  导入时间: <10秒
```

### 2.2 导入的小说列表

| # | 小说标题 | 字数 | 分类 |
|---|---------|------|------|
| 1 | 不会说话的你，被政界新贵指定联姻 | 10,966 | 现代言情 |
| 2 | 为了气前任我找了个牛郎，结果他是京圈太子爷 | 8,880 | 现代言情 |
| 3 | 他们说，只能选一个 | 8,209 | 现代言情 |
| 4 | 他去世后，那个陌生的双胞胎哥哥开始觊觎我 | 5,801 | 现代言情 |
| 5 | 他说，你只需要适应我一个人就够了 | 8,813 | 现代言情 |
| ... | ... | ... | ... |
| 34 | 闺蜜出国后，她那个从不说话的弟弟开始接近我 | 9,270 | 现代言情 |

**完整列表：** 共34篇，平均每篇约1万字

### 2.3 数据库最终状态

```
📚 小说总数: 44本
   - 原有: 10本（测试数据）
   - 新增: 34本（TXT导入）

📖 章节总数: 63章
   - 原有: 29章
   - 新增: 34章（每本短篇1章）
```

---

## 三、导入工具说明

### 3.1 工具功能

**文件：** `backend/scripts/import-txt-novels.js`

**核心功能：**
1. ✅ **自动扫描** - 扫描data目录下的所有.txt文件
2. ✅ **智能解析** - 提取标题、内容、字数
3. ✅ **自动分类** - 根据标题关键词自动分类
4. ✅ **去重处理** - 跳过已存在的小说
5. ✅ **批量导入** - 一次性导入所有文件
6. ✅ **统计报告** - 显示详细的导入统计

### 3.2 分类规则

导入工具会根据标题关键词自动分类：

| 分类ID | 分类名称 | 关键词 |
|--------|---------|--------|
| 101 | 现代言情 | 总裁、豪门、婚姻、恋爱、暧昧、前任、闪婚 |
| 102 | 古风穿越 | 穿越、重生、古风、宫廷、王爷、嫡女 |
| 103 | 悬疑推理 | 悬疑、推理、真相、谜团、杀手、死亡 |
| 104 | 治愈系 | 治愈、温暖、咖啡、相遇、温柔 |
| 105 | 玄幻奇幻 | 修真、仙侠、玄幻、灵气、大佬 |
| 106 | 科幻未来 | 科幻、星际、未来、机甲、游戏 |

**默认分类：** 如果没有匹配的关键词，默认分类为"现代言情"

### 3.3 数据结构

每个TXT文件会被转换为：

```javascript
{
  // 小说记录（novels表）
  novels: {
    title: "文件名（不含.txt）",
    author: "随机生成",
    category_id: "自动分类",
    description: "内容前200字",
    word_count: "实际字数",
    chapter_count: 1,  // 短篇固定为1
    status: 1,         // 已发布
    // ... 其他字段
  },
  
  // 章节记录（chapters表）
  chapters: {
    novel_id: "关联的小说ID",
    chapter_number: 1,
    title: "正文",
    content: "完整的TXT内容",
    word_count: "实际字数",
    is_free: 1         // 免费
  }
}
```

---

## 四、TXT文件格式要求

### 4.1 文件命名

**✅ 推荐格式：**
```
小说标题.txt
他说，你只需要适应我一个人就够了.txt
```

**❌ 不推荐：**
```
novel1.txt           # 标题不清晰
【完结】小说.txt      # 特殊符号可能有问题
第一章.txt           # 缺少小说名
```

### 4.2 文件内容格式

**最简单的格式：**
```
正文内容开始...
这是一个关于...的故事
（完整内容）
```

**也支持带标题的格式：**
```
小说标题

第一章：开始

正文内容...
```

**注意事项：**
- ✅ 使用UTF-8编码（避免乱码）
- ✅ 内容完整连贯
- ✅ 建议5000字以上
- ⚠️ 特殊字符会自动处理
- ⚠️ 过长内容（>100万字）建议分章节

---

## 五、使用场景

### 5.1 场景1：批量导入历史小说

```bash
# 1. 准备文件
将所有TXT小说放入 data/ 目录

# 2. 运行导入
cd backend
node scripts/import-txt-novels.js

# 3. 查看结果
# 访问 http://localhost:3008
# 新小说会出现在首页和推荐页
```

### 5.2 场景2：单个小说导入

```bash
# 1. 添加单个文件
data/新小说.txt

# 2. 运行导入（会自动跳过已存在的）
node scripts/import-txt-novels.js

# 3. 只导入新的小说
```

### 5.3 场景3：更新小说内容

```javascript
// 如果需要更新已存在的小说，需要：
// 1. 手动删除数据库中的记录
// 2. 或修改脚本中的 skip_duplicates 逻辑
```

---

## 六、高级功能

### 6.1 自定义分类

修改 `import-txt-novels.js` 中的分类映射：

```javascript
const CATEGORY_MAP = {
  101: { 
    name: '现代言情', 
    keywords: ['总裁', '豪门', '婚姻']  // 添加更多关键词
  },
  // 添加新分类
  107: { 
    name: '甜宠文', 
    keywords: ['甜宠', '宠文', '撒糖'] 
  }
};
```

### 6.2 自定义作者

```javascript
// 在 importNovel 函数中修改
const authorName = '你的笔名';  // 替换随机作者

// 或者从文件名解析作者
// 文件名格式：《小说名》作者名.txt
```

### 6.3 批量设置封面

```javascript
// 导入时指定封面
const coverUrl = `https://picsum.photos/seed/${novelId}/400/600`;

// 或者从本地上传
const coverPath = `/uploads/covers/${fileName}.jpg`;
```

---

## 七、故障排查

### 7.1 常见问题

**Q1: 导入后乱码？**
```
原因：文件编码不是UTF-8
解决：用记事本打开，另存为 UTF-8 编码
```

**Q2: 提示"小说已存在"？**
```
原因：数据库中已有同名小说
解决：
  - 方法1：修改文件名
  - 方法2：删除数据库中的旧记录
  - 方法3：修改脚本允许覆盖
```

**Q3: 导入失败？**
```
原因：数据库连接失败
检查：
  - MySQL服务是否启动
  - 用户名密码是否正确
  - 数据库 ai_xsread 是否存在
```

**Q4: 分类不对？**
```
原因：标题中没有匹配的关键词
解决：手动修改 CATEGORY_MAP 添加关键词
或：导入后在数据库中手动修改 category_id
```

### 7.2 调试模式

```javascript
// 在脚本中添加调试信息
console.log('解析结果:', novelData);
console.log('分类ID:', categoryId);
console.log('字数:', wordCount);
```

---

## 八、数据验证

### 8.1 检查导入结果

```bash
# 运行检查脚本
cd backend
node scripts/check-and-seed.js

# 查看小说列表
```

### 8.2 前端验证

```
1. 访问 http://localhost:3008
2. 查看首页 - 应该看到新导入的小说
3. 点击小说 - 查看详情
4. 开始阅读 - 测试阅读功能
```

### 8.3 数据库验证

```sql
-- 查看最新导入的小说
SELECT id, title, word_count, chapter_count 
FROM novels 
ORDER BY id DESC 
LIMIT 10;

-- 检查章节内容
SELECT novel_id, title, LENGTH(content) as content_length 
FROM chapters 
WHERE novel_id IN (SELECT id FROM novels ORDER BY id DESC LIMIT 5);
```

---

## 九、批量操作命令

### 9.1 清空导入的小说（谨慎使用）

```sql
-- 删除最近导入的小说
DELETE FROM chapters WHERE novel_id > 10;
DELETE FROM novels WHERE id > 10;

-- 重置自增ID
ALTER TABLE novels AUTO_INCREMENT = 11;
ALTER TABLE chapters AUTO_INCREMENT = 30;
```

### 9.2 重新导入

```bash
# 1. 清空数据（可选）
# 2. 确保TXT文件在data目录
# 3. 运行导入
node scripts/import-txt-novels.js
```

---

## 十、后台上传功能（开发中）

### 10.1 功能规划

**前端上传界面：**
- 管理后台页面
- 支持拖拽上传
- 批量选择文件
- 实时上传进度

**后端API：**
- POST /api/admin/novels/upload
- 解析TXT文件
- 自动入库
- 返回导入结果

### 10.2 开发计划

```
阶段1：命令行导入 ✅ 已完成
  └── import-txt-novels.js

阶段2：Web界面上传（计划中）
  ├── 后台管理页面
  ├── 文件上传API
  ├── 进度显示
  └── 批量处理

阶段3：增强功能（未来）
  ├── 章节自动分割
  ├── 封面自动生成
  ├── 标签自动提取
  └── 相似度检测
```

---

## 十一、最佳实践

### 11.1 文件组织

```
data/
├── 现代言情/
│   ├── 小说1.txt
│   └── 小说2.txt
├── 古风穿越/
│   └── 小说3.txt
└── 待分类/
    └── 小说4.txt
```

### 11.2 命名规范

```
推荐格式：
✅ 清晰简洁的标题.txt
✅ 带副标题的小说：主标题-副标题.txt

避免格式：
❌ 1.txt
❌ 未命名.txt
❌ 【完】【推荐】小说.txt（过多标记）
```

### 11.3 内容检查

导入前检查：
- ✅ 编码格式是否为UTF-8
- ✅ 内容是否完整
- ✅ 是否有明显的乱码
- ✅ 字数是否合理（建议5000+）

---

## 十二、导入工具技术细节

### 12.1 核心函数

**1. parseTxtFile() - 文件解析**
```javascript
function parseTxtFile(filePath) {
  // 读取文件
  const content = fs.readFileSync(filePath, 'utf8');
  
  // 提取标题（文件名）
  const title = path.basename(filePath, '.txt');
  
  // 计算字数
  const wordCount = content.replace(/\s/g, '').length;
  
  // 生成简介
  const description = content.substring(0, 200) + '...';
  
  return { title, content, wordCount, description };
}
```

**2. getCategoryId() - 自动分类**
```javascript
function getCategoryId(title) {
  for (const [categoryId, info] of Object.entries(CATEGORY_MAP)) {
    if (info.keywords.some(keyword => title.includes(keyword))) {
      return parseInt(categoryId);
    }
  }
  return 101; // 默认分类
}
```

**3. importNovel() - 数据库导入**
```javascript
async function importNovel(connection, novelData) {
  // 1. 检查重复
  // 2. 插入小说记录
  // 3. 插入章节内容
  // 4. 返回结果
}
```

### 12.2 数据流程

```
TXT文件
  ↓
读取文件内容 (fs.readFileSync)
  ↓
解析数据 (parseTxtFile)
  ├── 提取标题
  ├── 计算字数
  ├── 生成简介
  └── 自动分类
  ↓
检查重复 (SELECT)
  ↓
插入数据库
  ├── INSERT INTO novels
  └── INSERT INTO chapters
  ↓
完成 ✅
```

---

## 十三、示例输出

### 13.1 成功导入

```
======================================================================
📚 TXT小说批量导入工具
======================================================================

🔌 连接数据库...
✅ 数据库连接成功

📂 扫描目录: H:\momo-ruanjiansheji\AI_XsRead\data
📋 找到 34 个TXT文件

开始导入...

[1/34] 他说，你只需要适应我一个人就够了.txt
  ✅ 成功导入: 他说，你只需要适应我一个人就够了 (8813字)

[2/34] 为了气前任我找了个牛郎，结果他是京圈太子爷.txt
  ✅ 成功导入: 为了气前任我找了个牛郎，结果他是京圈太子爷 (8880字)

...

======================================================================
📊 导入统计
======================================================================
总文件数: 34
成功导入: 34 ✅
已存在: 0 ⏭️
导入失败: 0 ❌
======================================================================

📚 数据库现有:
  小说总数: 44
  章节总数: 63

🎉 导入完成！
💡 现在可以在前端阅读这些小说了
   访问: http://localhost:3008
```

---

## 十四、前端展示效果

### 14.1 首页

```
现在首页会显示44本小说，包括：
- 原有的10本测试小说
- 新导入的34本短篇小说
```

### 14.2 阅读页

**短篇小说阅读体验：**
```
┌─────────────────────────────────────────┐
│  [←] 他说，你只需要适应我一个人就够了  [≡] │ ← 小说标题
├─────────────────────────────────────────┤
│  字数: 8813  更新时间: 2025-10-28        │
│                                         │
│  你以为婚礼当天见到的陌生人只是走个形式  │
│  直到他握住你的脚踝说："别躲，我有的是  │
│  时间教你适应。"                         │
│                                         │
│  第一章：指定                            │
│                                         │
│  你是在父亲书房外听到自己被"处理掉"的... │
│  （完整内容一次性显示）                  │
│                                         │
│           [返回详情页]                   │ ← 简洁的返回按钮
├─────────────────────────────────────────┤
│       [夜间] [设置] [书架]               │ ← 精简的工具栏
└─────────────────────────────────────────┘
```

**特点：**
- ✅ 显示小说标题（不是章节标题）
- ✅ 无章节导航（不需要）
- ✅ 无进度条（单章节）
- ✅ 无目录按钮（无意义）
- ✅ 完整内容一次显示
- ✅ 阅读体验流畅

---

## 十五、总结

### ✅ 已完成
1. **导入工具开发** - 功能完善的TXT导入脚本
2. **批量导入测试** - 成功导入34本短篇小说
3. **自动分类** - 智能关键词匹配
4. **数据验证** - 所有数据正确入库

### 📊 成果统计
- **导入成功率：** 100% (34/34)
- **总字数：** 约35万字
- **平均字数：** 约1万字/篇
- **导入速度：** <10秒

### 🎯 使用效果
- ✅ data目录的TXT文件全部导入
- ✅ 前端可以正常浏览和阅读
- ✅ 短篇小说UI完美适配
- ✅ 阅读体验流畅自然

### 🚀 下一步
- ⭐ 可以继续添加更多TXT文件
- ⭐ 运行导入脚本即可
- ⭐ 无需重启前后端服务
- ⭐ 立即可以在网站上阅读

---

**工具位置：** `backend/scripts/import-txt-novels.js`  
**数据目录：** `H:\momo-ruanjiansheji\AI_XsRead\data\`  
**使用方法：** `node scripts/import-txt-novels.js`  
**文档生成时间：** 2025-10-28

