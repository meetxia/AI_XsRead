# 前后端联调配置说明

## 项目端口配置总览

| 项目 | 端口 | 说明 |
|------|------|------|
| ai-xsread-vue3 (前端) | 3008 | 用户端前端应用 |
| backend (后端API) | 8005 | 用户端后端API服务 |
| admin-frontend (管理前端) | 3010 | 管理后台前端应用 |
| admin-backend (管理后端) | 8001 | 管理后台后端API服务 |

## 配置文件说明

### 1. ai-xsread-vue3 前端配置

**文件：`ai-xsread-vue3/.env`**
```env
# 应用标题
VITE_APP_TITLE=文字之境

# 后端API地址
VITE_APP_BASE_API=http://localhost:8005
```

**文件：`ai-xsread-vue3/vite.config.js`**
- 开发服务器端口：3008
- API代理目标：http://localhost:8005（已修复）

### 2. backend 后端配置

**文件：`backend/.env`**
```env
PORT=8005
NODE_ENV=development
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=toefl_user
DB_PASSWORD=mojz168168
DB_DATABASE=ai_xsread
JWT_SECRET=your-secret-key-change-in-production-2025
JWT_EXPIRES_IN=2h
JWT_REFRESH_SECRET=your-refresh-secret-key-change-in-production-2025
JWT_REFRESH_EXPIRES_IN=7d
UPLOAD_DIR=uploads
MAX_FILE_SIZE=5242880
CORS_ORIGIN=http://localhost:3008,http://127.0.0.1:3008
```

**CORS配置说明**：
- 支持多个源，用逗号分隔
- 包含 localhost 和 127.0.0.1，确保兼容性

### 3. admin-frontend 管理前端配置

**需要创建文件：`admin-frontend/.env`**
```env
# 应用标题
VITE_APP_TITLE=文字之境后台管理系统

# 后端API地址
VITE_APP_BASE_API=http://localhost:8001
```

**文件：`admin-frontend/vite.config.js`**
- 开发服务器端口：3010
- API代理目标：http://localhost:8001

### 4. admin-backend 管理后端配置

**需要创建文件：`admin-backend/.env`**
```env
PORT=8001
NODE_ENV=development
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=toefl_user
DB_PASSWORD=mojz168168
DB_NAME=ai_xsread
JWT_SECRET=admin-secret-key-change-in-production-2025
JWT_EXPIRES_IN=2h
JWT_REFRESH_EXPIRES_IN=7d
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=2097152
CORS_ORIGIN=http://localhost:3010,http://127.0.0.1:3010
LOG_LEVEL=info
```

## 启动顺序

### 方式一：手动启动（推荐用于调试）

1. **启动数据库**（确保MySQL已启动）

2. **启动后端服务**
```bash
# 终端1：启动用户端后端
cd backend
npm run dev

# 终端2：启动管理后台后端
cd admin-backend
npm run dev
```

3. **启动前端应用**
```bash
# 终端3：启动用户端前端
cd ai-xsread-vue3
npm run dev

# 终端4：启动管理后台前端
cd admin-frontend
npm run dev
```

### 方式二：使用PowerShell脚本启动（Windows）

**创建启动脚本：`启动开发环境.ps1`**
```powershell
# 启动所有服务
Write-Host "正在启动文字之境开发环境..." -ForegroundColor Green

# 启动后端服务
Start-Process powershell -ArgumentList "-NoExit", "-Command", "cd backend; npm run dev"
Start-Sleep -Seconds 2

Start-Process powershell -ArgumentList "-NoExit", "-Command", "cd admin-backend; npm run dev"
Start-Sleep -Seconds 2

# 启动前端服务
Start-Process powershell -ArgumentList "-NoExit", "-Command", "cd ai-xsread-vue3; npm run dev"
Start-Sleep -Seconds 2

Start-Process powershell -ArgumentList "-NoExit", "-Command", "cd admin-frontend; npm run dev"

Write-Host "所有服务已启动！" -ForegroundColor Green
```

## 常见问题排查

### 1. CORS错误

**现象**：浏览器控制台显示 `Access to XMLHttpRequest at 'http://localhost:8005' from origin 'http://localhost:3008' has been blocked by CORS policy`

**解决方案**：
- 检查后端 `.env` 文件中的 `CORS_ORIGIN` 配置
- 确保包含前端的完整地址（包括协议和端口）
- 重启后端服务使配置生效

### 2. 连接被拒绝（ERR_CONNECTION_REFUSED）

**现象**：`GET http://localhost:8005/api/novels net::ERR_CONNECTION_REFUSED`

**解决方案**：
- 检查后端服务是否正常运行
- 确认后端端口配置正确（8005）
- 检查防火墙是否阻止了端口访问

### 3. 数据库连接失败

**现象**：后端启动时显示 `❌ 数据库连接失败`

**解决方案**：
- 检查MySQL服务是否启动
- 确认数据库配置（用户名、密码、数据库名）是否正确
- 检查数据库 `ai_xsread` 是否已创建
- 验证数据库用户 `toefl_user` 是否有足够权限

### 4. API接口404错误

**现象**：`GET http://localhost:8005/api/novels 404 (Not Found)`

**解决方案**：
- 检查后端路由配置
- 确认API路径是否正确
- 查看后端日志排查问题

### 5. Token过期或未授权（401错误）

**现象**：`401 Unauthorized`

**解决方案**：
- 清除浏览器localStorage中的token
- 重新登录获取新token
- 检查JWT配置是否正确

## 测试API连通性

### 健康检查接口

**用户端后端**：
```bash
curl http://localhost:8005/api/health
```

**管理后台后端**：
```bash
curl http://localhost:8001/api
```

### 测试数据库连接

```bash
# 在backend或admin-backend目录下运行
node -e "const {testConnection} = require('./src/config/database'); testConnection();"
```

## 开发建议

1. **使用浏览器开发者工具**
   - Network标签查看请求详情
   - Console标签查看错误信息

2. **查看后端日志**
   - 后端终端会显示所有请求日志
   - 留意错误堆栈信息

3. **环境变量修改后记得重启**
   - 修改 `.env` 文件后需要重启对应服务
   - 前端的环境变量是在构建时注入的

4. **数据库定期备份**
   - 使用 `backend/scripts/backup.bat` 进行备份
   - 开发过程中养成定期备份习惯

## 访问地址汇总

- 用户端前端：http://localhost:3008
- 管理后台前端：http://localhost:3010
- 用户端API：http://localhost:8005
- 管理后台API：http://localhost:8001

---

**最后更新**：2025-10-27

